<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="https://github.com/thymeleaf/thymeleaf-extras-springsecurity"
      xmlns:data="https://github.com/mxab/thymeleaf-extras-data-attribute"
      layout:decorate="~{base}">

  <head>
    <title th:text="|#{fileresources}: #{fileresources_create}|">Files: Upload a new file</title>
    <link rel=stylesheet th:href="@{/css/thirdparty/prosemirror.css}" />
  </head>
  <body>
    <section layout:fragment="content">
      <form id="editor-form" th:action="@{/fileresources/new/upload?__${_csrf.parameterName}__=__${_csrf.token}__}" method="post" enctype="multipart/form-data" role="form">

        <div class="row">
          <div class="col-sm-6">
            <h1 th:text="|#{fileresources}: #{fileresources_create}|">Files: Upload a new file</h1>
          </div>
          <div class="col-sm-6">
            <div class="float-right">
              <a class="btn btn-secondary" type="button" th:href="@{/fileresources}" th:text="#{abort}">abort</a>
              <button id="uploadButton" class="btn btn-primary" type="submit" th:text="#{next}">next</button>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-sm-12">
            <hr/>
          </div>
        </div>

        <div class="row mainContent">
          <!--<div th:replace="fragments/feedback-messages :: form-bootstrap4"></div>-->

          <div class="col-sm-12">
            <div id="progressBar" class="progress">
              <div id="bar" class="progress-bar progress-bar-striped" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>
          </div>
        </div>

        <div class="row mainContent">
          <div class="col-sm-12">
            <div class="form-group">
              <label th:text="#{file}">File</label>
              <input name="file" type="file" id="files">
              <output id="selectedFiles"></output>
            </div>
          </div>
        </div>
      </form>
    </section>

  <th:block layout:fragment="beforeBodyEnds">
    <script th:src="@{/js/thirdparty/bootstrap-filestyle.min.js}" type="text/javascript"></script>
    <script>
      $('#files').filestyle({
        buttonName: 'btn-info'
//        buttonText: ' Select a File'
      });
    </script>
    <script>
      var totalFileLength, totalUploaded, fileCount, filesUploaded;

      //To log everything on console
      function debug(s) {
        var debug = document.getElementById('debug');
        if (debug) {
          debug.innerHTML = debug.innerHTML + '<br/>' + s;
        }
      }

      //Will be called when upload is completed
      function onUploadComplete(e) {
        totalUploaded += document.getElementById('files').files[filesUploaded].size;
        filesUploaded++;
        debug('complete ' + filesUploaded + " of " + fileCount);
        debug('totalUploaded: ' + totalUploaded);
        if (filesUploaded < fileCount) {
          uploadNext();
        } else {
          var bar = document.getElementById('bar');
          bar.style.width = '100%';
          bar.innerHTML = '100% complete';
//          alert('Finished uploading file(s)');
        }
      }

      //Will be called when user select the files in file control
      function onFileSelect(e) {
        var files = e.target.files; // FileList object
        var output = [];
        fileCount = files.length;
        totalFileLength = 0;
        for (var i = 0; i < fileCount; i++) {
          var file = files[i];
          output.push(file.name, ' (', file.size, ' bytes, ', file.lastModifiedDate.toLocaleDateString(), ')');
          output.push('<br/>');
          debug('add ' + file.size);
          totalFileLength += file.size;
        }
        document.getElementById('selectedFiles').innerHTML = output.join('');
        debug('totalFileLength:' + totalFileLength);
      }

      //This will continueously update the progress bar
      function onUploadProgress(e) {
        if (e.lengthComputable) {
          var percentComplete = parseInt((e.loaded + totalUploaded) * 100 / totalFileLength);
          var bar = document.getElementById('bar');
          bar.style.width = percentComplete + '%';
          bar.innerHTML = percentComplete + ' %';
          bar.setAttribute("aria-valuenow", percentComplete);
        } else {
          debug('unable to compute');
        }
      }

      //the Ouchhh !! moments will be captured here
      function onUploadFailed(e) {
        alert("Error uploading file");
      }

      //Pick the next file in queue and upload it to remote server
      function uploadNext() {
        var xhr = new XMLHttpRequest();
        var fd = new FormData();
        var file = document.getElementById('files').files[filesUploaded];
        fd.append("multipartFile", file);
        xhr.upload.addEventListener("progress", onUploadProgress, false);
        xhr.addEventListener("load", onUploadComplete, false);
        xhr.addEventListener("error", onUploadFailed, false);
        xhr.open("POST", "/api/file");
        debug('uploading ' + file.name);
        xhr.send(fd);
      }

      //Let's begin the upload process
      function startUpload() {
        totalUploaded = filesUploaded = 0;
        uploadNext();
      }

      //Event listeners for button clicks
      window.onload = function () {
        document.getElementById('files').addEventListener('change', onFileSelect, false);
        document.getElementById('uploadButton').addEventListener('click', startUpload, false);
      }
    </script>
    <div th:replace="fragments/modals :: confirmYesNoDialog"></div>
    <div th:replace="fragments/modals :: formValidationDialog"></div>
  </th:block>
</body>

</html>